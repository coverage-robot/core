WITH
  availability AS (
    SELECT
      COMMIT,
      tag,
      ARRAY_AGG(totalLines) AS successfullyUploadedLines,
      ARRAY_AGG(
        STRING(ingestTime)
      ) AS ingestTimes
    FROM
      `mock-table`
    WHERE
      provider = @PROVIDER
      AND owner = @OWNER
      AND repository = @REPOSITORY -- Only include uploads on tags which are recent. That way we can avoid permanently
      -- looking for tags deep in the commit history which are obsolete/no longer uploaded.
      AND ingestTime > CAST(
        TIMESTAMP_SUB(
          CURRENT_TIMESTAMP(),
          INTERVAL 120 DAY
        ) AS DATETIME
      )
    GROUP BY
      COMMIT,
      tag
  )
SELECT
  availability.tag AS tagName,
  ARRAY_AGG(
    STRUCT(
      COMMIT AS `commit`, tag AS name, successfullyUploadedLines AS successfullyUploadedLines,
      ingestTimes AS ingestTimes
    )
  ) AS carryforwardTags,
FROM
  availability
GROUP BY
  availability.tag